/*! Esri-Leaflet - v0.0.1 - 2013-05-14
*   Copyright (c) 2013 Environmental Systems Research Institute, Inc.
*   Apache License*/

L.esri={TILES:{Streets:{urlTemplate:"http://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}",attributionUrl:"http://static.arcgis.com/attribution/World_Street_Map?f=json",options:{minZoom:1,maxZoom:19,attribution:"<span id='esri-attributions'>Esri</span><img src='http://serverapi.arcgisonline.com/jsapi/arcgis/3.4/js/esri/images/map/logo-med.png' alt='Powered by Esri' class='esri-attribution-logo'>"}},Topographic:{urlTemplate:"http://services.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}",attributionUrl:"http://static.arcgis.com/attribution/World_Topo_Map?f=json",options:{minZoom:1,maxZoom:19,attribution:"<span id='esri-attributions'>Esri</span><img src='http://serverapi.arcgisonline.com/jsapi/arcgis/3.4/js/esri/images/map/logo-med.png' alt='Powered by Esri' class='esri-attribution-logo'>"}},Oceans:{urlTemplate:"http://server.arcgisonline.com/ArcGIS/rest/services/Ocean_Basemap/MapServer/tile/{z}/{y}/{x}",attributionUrl:"http://static.arcgis.com/attribution/Ocean_Basemap?f=json",options:{minZoom:1,maxZoom:19,attribution:"<span id='esri-attributions'>Esri</span><img src='http://serverapi.arcgisonline.com/jsapi/arcgis/3.4/js/esri/images/map/logo-med.png' alt='Powered by Esri' class='esri-attribution-logo'>"}},NationalGeographic:{urlTemplate:"http://server.arcgisonline.com/ArcGIS/rest/services/NatGeo_World_Map/MapServer/tile/{z}/{y}/{x}",options:{minZoom:1,maxZoom:19,attribution:"<span id='esri-attributions'>Esri</span><img src='http://serverapi.arcgisonline.com/jsapi/arcgis/3.4/js/esri/images/map/logo-med.png' alt='Powered by Esri' class='esri-attribution-logo'>"}},Gray:{urlTemplate:"http://services.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Base/MapServer/tile/{z}/{y}/{x}",options:{minZoom:1,maxZoom:19,attribution:"<span id='esri-attributions'>Copyright: &copy;2013 Esri, DeLorme, NAVTEQ</span><img src='http://serverapi.arcgisonline.com/jsapi/arcgis/3.4/js/esri/images/map/logo-med.png' alt='Powered by Esri' class='esri-attribution-logo'>"}},GrayLabels:{urlTemplate:"http://services.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Reference/MapServer/tile/{z}/{y}/{x}",options:{minZoom:1,maxZoom:19}},Imagery:{urlTemplate:"http://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",options:{minZoom:1,maxZoom:19,attribution:"<span id='esri-attributions'>Esri, DigitalGlobe, GeoEye, i-cubed, USDA, USGS, AEX, Getmapping, Aerogrid, IGN, IGP, swisstopo, and the GIS User Community</span><img src='http://serverapi.arcgisonline.com/jsapi/arcgis/3.4/js/esri/images/map/logo-med.png' alt='Powered by Esri' class='esri-attribution-logo'>"}},ImageryLabels:{urlTemplate:"http://services.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}",options:{minZoom:1,maxZoom:19}}}},L.esri.TileLayer=L.TileLayer.extend({initialize:function(t,i){var e;if("object"==typeof t&&t.urlTemplate&&t.options)e=t;else{if("string"!=typeof t||!L.esri.TILES[t])throw Error("L.esri.TileLayer: Invalid parameter. Use one of 'Streets', 'Topographic', 'Oceans', 'NationalGeographic', 'Gray', 'GrayLabels', 'Imagery' or 'ImageryLabels'");e=L.esri.TILES[t]}var o=L.Util.extend(e.options,i);L.TileLayer.prototype.initialize.call(this,e.urlTemplate,L.Util.setOptions(this,o)),e.attributionUrl&&(this.dynamicAttribution=!0,this.getAttributionData(e.attributionUrl))},dynamicAttribution:!1,bounds:null,zoom:null,handleTileUpdates:function(t){var i,e;"load"===t.type&&(i=this._map.getBounds(),e=this._map.getZoom()),("viewreset"===t.type||"dragend"===t.type||"zoomend"===t.type)&&(i=t.target.getBounds(),e=t.target.getZoom()),this.attributionBoundingBoxes&&i&&e&&(i.equals(this.bounds)&&e===this.zoom||(this.bounds=i,this.zoom=e,this.updateMapAttribution()))},onAdd:function(t){L.TileLayer.prototype.onAdd.call(this,t),this.dynamicAttribution&&(this.on("load",this.handleTileUpdates),this._map.on("viewreset zoomend dragend",this.handleTileUpdates))},onRemove:function(){L.TileLayer.prototype.onRemove.call(this),this.dynamicAttribution&&(this.off("load",this.handleTileUpdates),this._map.off("viewreset zoomend dragend",this.handleTileUpdates))},getAttributionData:function(t){this.attributionBoundingBoxes=[];var i;window.XMLHttpRequest?i=new XMLHttpRequest:window.ActiveXObject&&(i=new ActiveXObject("Microsoft.XMLHTTP")),i.onreadystatechange=L.bind(this.processAttributionData,this),i.open("GET",t,!0),i.send(null)},processAttributionData:function(t){if(4===t.target.readyState&&200===t.target.status){for(var i=JSON.parse(t.target.responseText),e=0;i.contributors.length>e;e++)for(var o=i.contributors[e],r=0;o.coverageAreas.length>r;r++){var s=o.coverageAreas[r],a=new L.LatLng(s.bbox[0],s.bbox[1]),n=new L.LatLng(s.bbox[2],s.bbox[3]);this.attributionBoundingBoxes.push({attribution:o.attribution,score:s.score,bounds:new L.LatLngBounds(a,n),minZoom:s.zoomMin,maxZoom:s.zoomMax})}this.attributionBoundingBoxes.sort(function(t,i){return t.score<i.score?-1:t.score>i.score?1:0}),this.bounds&&this.updateMapAttribution()}},updateMapAttribution:function(){for(var t=[],i=0;this.attributionBoundingBoxes.length>i;i++){var e=this.attributionBoundingBoxes[i];if(this.bounds.intersects(e.bounds)&&this.zoom>=e.minZoom&&this.zoom<=e.maxZoom){var o=this.attributionBoundingBoxes[i].attribution;-1===t.indexOf(o)&&t.push(o)}}L.DomUtil.get("esri-attributions").innerHTML=t.join(", ")}}),L.esri.tileLayer=function(t,i){return new L.esri.TileLayer(t,i)},L.esri.FeatureLayer=L.FeatureGroup.extend({initialize:function(){L.FeatureGroup.prototype.initialize.call(this,[])}}),L.esri.featureLayer=function(t,i){return new L.esri.FeatureLayer(t,i)};