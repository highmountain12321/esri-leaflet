/*! Esri-Leaflet - v0.0.1-beta.4 - 2014-05-09
*   Copyright (c) 2014 Environmental Systems Research Institute, Inc.
*   Apache License*/
L.esri={VERSION:"0.0.1-beta.5",Layers:{},Services:{},Util:{},Support:{CORS:!!(window.XMLHttpRequest&&"withCredentials"in new XMLHttpRequest),pointerEvents:""===document.documentElement.style.pointerEvents}},function(L){function a(a){var b={};for(var c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);return b}function b(a){var b,c=0,d=0,e=a.length,f=a[d];for(d;e-1>d;d++)b=a[d+1],c+=(b[0]-f[0])*(b[1]+f[1]),f=b;return c>=0}function c(a,b,c,d){var e=(d[0]-c[0])*(a[1]-c[1])-(d[1]-c[1])*(a[0]-c[0]),f=(b[0]-a[0])*(a[1]-c[1])-(b[1]-a[1])*(a[0]-c[0]),g=(d[1]-c[1])*(b[0]-a[0])-(d[0]-c[0])*(b[1]-a[1]);if(0!==g){var h=e/g,i=f/g;if(h>=0&&1>=h&&i>=0&&1>=i)return!0}return!1}function d(a,b){for(var d=0;d<a.length-1;d++)for(var e=0;e<b.length-1;e++)if(c(a[d],a[d+1],b[e],b[e+1]))return!0;return!1}function e(a,b){for(var c=!1,d=-1,e=a.length,f=e-1;++d<e;f=d)(a[d][1]<=b[1]&&b[1]<a[f][1]||a[f][1]<=b[1]&&b[1]<a[d][1])&&b[0]<(a[f][0]-a[d][0])*(b[1]-a[d][1])/(a[f][1]-a[d][1])+a[d][0]&&(c=!c);return c}function f(a,b){var c=d(a,b),f=e(a,b[0]);return!c&&f?!0:!1}function g(a){for(var c=[],d=[],e=0;e<a.length;e++){var g=a[e].slice(0);if(b(g)){var h=[g];c.push(h)}else d.push(g)}for(;d.length;){for(var i=d.pop(),j=!1,k=c.length-1;k>=0;k--){var l=c[k][0];if(f(l,i)){c[k].push(i),j=!0;break}}j||c.push([i.reverse()])}return 1===c.length?{type:"Polygon",coordinates:c[0]}:{type:"MultiPolygon",coordinates:c}}function h(a){var c=[],d=a.slice(0),e=d.shift().slice(0);b(e)||e.reverse(),c.push(e);for(var f=0;f<d.length;f++){var g=d[f].slice(0);b(g)&&g.reverse(),c.push(g)}return c}function i(a){for(var b=[],c=0;c<a.length;c++)for(var d=h(a[c]),e=d.length-1;e>=0;e--){var f=d[e].slice(0);b.push(f)}return b}L.esri.Util.trim=function(a){return a.replace(/^\s\s*/,"").replace(/\s\s*$/,"")},L.esri.Util.cleanUrl=function(a){return a=L.esri.Util.trim(a),"/"!==a[a.length-1]&&(a+="/"),a},L.esri.Util.serialize=function(a){var b="";for(var c in a)if(a.hasOwnProperty(c)){var d=c,e=a[c];b+=encodeURIComponent(d),b+="=",b+=encodeURIComponent(e),b+="&"}return b.substring(0,b.length-1)},L.esri.Util.indexOf=function(a,b,c){if(c=c||0,a.indexOf)return a.indexOf(b,c);for(var d=c,e=a.length;e>d;d++)if(a[d]===b)return d;return-1},L.esri.Util.extentToBounds=function(a){var b=new L.LatLng(a.ymin,a.xmin),c=new L.LatLng(a.ymax,a.xmax);return new L.LatLngBounds(b,c)},L.esri.Util.boundsToExtent=function(a){return{xmin:a.getSouthWest().lng,ymin:a.getSouthWest().lat,xmax:a.getNorthEast().lng,ymax:a.getNorthEast().lat,spatialReference:{wkid:4326}}},L.esri.Util.arcgisToGeojson=function(b,c){var d={};return c=c||{},c.idAttribute=c.idAttribute||void 0,b.x&&b.y&&(d.type="Point",d.coordinates=[b.x,b.y]),b.points&&(d.type="MultiPoint",d.coordinates=b.points.slice(0)),b.paths&&(1===b.paths.length?(d.type="LineString",d.coordinates=b.paths[0].slice(0)):(d.type="MultiLineString",d.coordinates=b.paths.slice(0))),b.rings&&(d=g(b.rings.slice(0))),(b.geometry||b.attributes)&&(d.type="Feature",d.geometry=b.geometry?L.esri.Util.arcgisToGeojson(b.geometry):null,d.properties=b.attributes?a(b.attributes):null,b.attributes&&(d.id=b.attributes[c.idAttribute]||b.attributes.OBJECTID||b.attributes.FID)),d},L.esri.Util.geojsonToArcGIS=function(a,b){var c,d=b&&b.idAttribute?b.idAttribute:"OBJECTID",e=b&&b.sr?{wkid:b.sr}:{wkid:4326},f={};switch(a.type){case"Point":f.x=a.coordinates[0],f.y=a.coordinates[1],f.spatialReference=e;break;case"MultiPoint":f.points=a.coordinates.slice(0),f.spatialReference=e;break;case"LineString":f.paths=[a.coordinates.slice(0)],f.spatialReference=e;break;case"MultiLineString":f.paths=a.coordinates.slice(0),f.spatialReference=e;break;case"Polygon":f.rings=h(a.coordinates.slice(0)),f.spatialReference=e;break;case"MultiPolygon":f.rings=i(a.coordinates.slice(0)),f.spatialReference=e;break;case"Feature":a.geometry&&(f.geometry=L.esri.Util.geojsonToArcGIS(a.geometry,b)),f.attributes=a.properties?L.esri.Util.clone(a.properties):{},f.attributes[d]=a.id;break;case"FeatureCollection":for(f=[],c=0;c<a.features.length;c++)f.push(L.esri.Util.geojsonToArcGIS(a.features[c],b));break;case"GeometryCollection":for(f=[],c=0;c<a.geometries.length;c++)f.push(L.esri.Util.geojsonToArcGIS(a.geometries[c],b))}return f},L.esri.Util.featureSetToFeatureCollection=function(a){var b;if(a.objectIdFieldName)b=a.objectIdFieldName;else if(a.fields)for(var c=0;c<=a.fields.length-1;c++)if("esriFieldTypeOID"===a.fields[c].type){b=a.fields[c].name;break}var d={type:"FeatureCollection",features:[]};if(a.features.length)for(var e=a.features.length-1;e>=0;e--)d.features.push(L.esri.Util.arcgisToGeojson(a.features[e],{idAttribute:b}));return d}}(L),function(L){function a(a,b){var c=new XMLHttpRequest;return c.onreadystatechange=function(){var d,e;if(4===c.readyState){try{d=JSON.parse(c.responseText)}catch(f){d=null,e={error:"Could not parse response as JSON.",code:500}}!e&&d.error&&(e=d.error,d=null),a.call(b,e,d)}},c}L.esri.RequestHandlers={post:function(b,c,d,e){c.f="json";var f=a(d,e);f.open("POST",b),f.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),f.send(L.esri.Util.serialize(c))},get:{CORS:function(b,c,d,e){c.f="json";var f=a(d,e);f.open("GET",b+"?"+L.esri.Util.serialize(c),!0),f.send(null)},JSONP:function(a,b,c,d){L.esri._callback=L.esri._callback||{};var e="c"+(1e9*Math.random()).toString(36).replace(".","_");b.f="json",b.callback="L.esri._callback."+e;var f=L.DomUtil.create("script",null,document.body);f.type="text/javascript",f.src=a+"?"+L.esri.Util.serialize(b),f.id=e,L.esri._callback[e]=function(a){var b,g=Object.prototype.toString.call(a);"[object Object]"!==g&&"[object Array]"!==g&&(b={code:500,error:"Expected array or object as JSONP response"},a=null),!b&&a.error&&(b=a.error,a=null),c.call(d,b,a),document.body.removeChild(f),delete L.esri._callback[e]}}}},L.esri.get=L.esri.Support.CORS?L.esri.RequestHandlers.get.CORS:L.esri.RequestHandlers.get.JSONP,L.esri.post=L.esri.RequestHandlers.post}(L),L.esri.Services.MapService=L.esri.Service.extend({identify:function(){return new L.esri.Services.Identify(this)},query:function(){return new L.esri.Services.Query(this)}}),L.esri.Services.mapService=function(a,b){return new L.esri.Services.MapService(a,b)},L.esri.Services.Identify=L.Class.extend({initialize:function(a,b){a.url&&a.get?(this._service=a,this.url=a.url):this.url=a+"query",this._params={sr:4326,layers:"all"};for(var c in b)b.hasOwnProperty(c)&&b.key&&this[c].apply(this,b[c])},at:function(a,b,c){var d=L.esri.Util.boundsToExtent(b);return this._params.geometry=[a.lng,a.lat].join(","),this._params.geometryType="esriGeometryPoint",this._params.tolerance=c||3,this._params.mapExtent=[d.xmin,d.xmax,d.ymin,d.ymax].join(","),this},within:function(a){var b=L.esri.Util.boundsToExtent(a);return this._params.geometry=JSON.stringify(b),this._params.geometryType="esriGeometryEnvelope",this._params.spatialRel="esriSpatialRelIntersects",this._params.mapExtent=[b.xmin,b.xmax,b.ymin,b.ymax].join(","),this},layerDef:function(a,b){return this._params.layerDefs=this._params.layerDefs?this._params.layerDefs+";":"",this._params.layerDefs+=[a,b].join(":"),this},between:function(a,b){return this._params.time=[a,b].join(),this},layers:function(a){return this._params.layers=a,this},precision:function(a){return this._params.geometryPrecision=a,this},simplify:function(a,b){var c=Math.abs(a.getBounds().getWest()-a.getBounds().getEast());return this._params.maxAllowableOffset=c/a.getSize().y*(1-b),this},size:function(a,b,c){var d=c&&L.Browser.retina?2:1;return this._params.imageDisplay=a*d+","+b*d+","+96*d,this},run:function(a,b){this._request(function(c,d){a.call(b,c,d)},b)},_request:function(a,b){this._service?this._service.get("identify",this._params,a,b):L.esri.get(this.url,this._params,a,b)}}),L.esri.Services.identify=function(a,b){return new L.esri.Services.Identify(a,b)},L.esri.Services.Query=L.Class.extend({initialize:function(a,b){a.url&&a.get?(this._service=a,this.url=a.url):this.url=a,this._params={outSr:4326};for(var c in b)b.hasOwnProperty(c)&&b.key&&this[c].apply(this,b[c])},within:function(a){return this._params.geometry=JSON.stringify(L.esri.Util.boundsToExtent(a)),this._params.geometryType="esriGeometryEnvelope",this._params.spatialRel="esriSpatialRelIntersects",this},intersects:function(a){return this._params.geometry=JSON.stringify(L.esri.Util.geojsonToArcGIS(a.toGeoJSON())),this._params.geometryType="esriGeometryPolyline",this._params.spatialRel="esriSpatialRelIntersects",this},around:function(a,b){return this._params.geometry=[a.lng,a.lat].join(","),this._params.geometryType="esriGeometryPoint",this._params.spatialRel="esriSpatialRelIntersects",this._params.units="esriSRUnit_Meter",this._params.distance=b,this._params.inSr=4326,this},layerDef:function(a,b){return this._params.layerDefs=this._params.layerDefs?this._params.layerDefs+";":"",this._params.layerDefs+=[a,b].join(":"),this},where:function(a){return this._params.where=a,this},offset:function(a){return this._params.offset=a,this},limit:function(a){return this._params.limit=a,this},between:function(a,b){return this._params.time=[a.valueOf(),b.valueOf()].join(),this},fields:function(a){return this._params.outFields=a.join(","),this},precision:function(a){return this._params.geometryPrecision=a,this},simplify:function(a,b){var c=Math.abs(a.getBounds().getWest()-a.getBounds().getEast());return this._params.maxAllowableOffset=c/a.getSize().y*b,this},orderBy:function(a,b){return this._params.orderByFields=this._params.orderByFields?this._params.orderByFields+",":"",this._params.orderByFields+=[a,b||"ASC"].join(","),this},featureIds:function(a){return this._params.objectIds=a.join(","),this},token:function(a){return this._params.token=a,this},run:function(a,b){this._request(function(c,d){d=c?null:L.esri.Util.featureSetToFeatureCollection(d),a.call(b,c,d)},b)},count:function(a,b){this._params.returnCountOnly=!0,this._request(a,b)},ids:function(a,b){this._params.returnIdsOnly=!0,this._request(a,b)},bounds:function(a,b){this._params.returnExtentOnly=!0,this._params.returnCountOnly=!0,this._request(a,b)},_request:function(a,b){this._service?this._service.get("query",this._params,a,b):L.esri.get(this.url,this._params,a,b)}}),L.esri.Services.query=function(a,b){return new L.esri.Services.Query(a,b)};