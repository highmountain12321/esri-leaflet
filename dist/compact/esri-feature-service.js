/*! Esri-Leaflet - v0.0.1-beta.4 - 2014-04-29
*   Copyright (c) 2014 Environmental Systems Research Institute, Inc.
*   Apache License*/
L.esri={VERSION:"0.0.1-beta.5",Layers:{},Services:{},Util:{},Support:{CORS:!!(window.XMLHttpRequest&&"withCredentials"in new XMLHttpRequest),pointerEvents:""===document.documentElement.style.pointerEvents}},function(L){function a(a){var b={};for(var c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);return b}function b(a){var b,c=0,d=0,e=a.length,f=a[d];for(d;e-1>d;d++)b=a[d+1],c+=(b[0]-f[0])*(b[1]+f[1]),f=b;return c>=0}function c(a,b,c,d){var e=(d[0]-c[0])*(a[1]-c[1])-(d[1]-c[1])*(a[0]-c[0]),f=(b[0]-a[0])*(a[1]-c[1])-(b[1]-a[1])*(a[0]-c[0]),g=(d[1]-c[1])*(b[0]-a[0])-(d[0]-c[0])*(b[1]-a[1]);if(0!==g){var h=e/g,i=f/g;if(h>=0&&1>=h&&i>=0&&1>=i)return!0}return!1}function d(a,b){for(var d=0;d<a.length-1;d++)for(var e=0;e<b.length-1;e++)if(c(a[d],a[d+1],b[e],b[e+1]))return!0;return!1}function e(a,b){for(var c=!1,d=-1,e=a.length,f=e-1;++d<e;f=d)(a[d][1]<=b[1]&&b[1]<a[f][1]||a[f][1]<=b[1]&&b[1]<a[d][1])&&b[0]<(a[f][0]-a[d][0])*(b[1]-a[d][1])/(a[f][1]-a[d][1])+a[d][0]&&(c=!c);return c}function f(a,b){var c=d(a,b),f=e(a,b[0]);return!c&&f?!0:!1}function g(a){for(var c=[],d=[],e=0;e<a.length;e++){var g=a[e].slice(0);if(b(g)){var h=[g];c.push(h)}else d.push(g)}for(;d.length;){for(var i=d.pop(),j=!1,k=c.length-1;k>=0;k--){var l=c[k][0];if(f(l,i)){c[k].push(i),j=!0;break}}j||c.push([i.reverse()])}return 1===c.length?{type:"Polygon",coordinates:c[0]}:{type:"MultiPolygon",coordinates:c}}function h(a){for(var b=null,c=null,d=null,e=null,f=0;f<a.length;f++){var g=a[f],h=g[0],i=g[1];null===b?b=h:b>h&&(b=h),null===c?c=h:h>c&&(c=h),null===d?d=i:d>i&&(d=i),null===e?e=i:i>e&&(e=i)}return[b,d,c,e]}function i(a){for(var b=null,c=null,d=null,e=null,f=0;f<a.length;f++)for(var g=a[f],h=0;h<g.length;h++){var i=g[h],j=i[0],k=i[1];null===b?b=j:b>j&&(b=j),null===c?c=j:j>c&&(c=j),null===d?d=k:d>k&&(d=k),null===e?e=k:k>e&&(e=k)}return[b,d,c,e]}function j(a){for(var b=null,c=null,d=null,e=null,f=0;f<a.length;f++)for(var g=a[f],h=0;h<g.length;h++)for(var i=g[h],j=0;j<i.length;j++){var k=i[j],l=k[0],m=k[1];null===b?b=l:b>l&&(b=l),null===c?c=l:l>c&&(c=l),null===d?d=m:d>m&&(d=m),null===e?e=m:m>e&&(e=m)}return[b,d,c,e]}function k(a){var c=[],d=a.slice(0),e=d.shift().slice(0);b(e)||e.reverse(),c.push(e);for(var f=0;f<d.length;f++){var g=d[f].slice(0);b(g)&&g.reverse(),c.push(g)}return c}function l(a){for(var b=[],c=0;c<a.length;c++)for(var d=k(a[c]),e=d.length-1;e>=0;e--){var f=d[e].slice(0);b.push(f)}return b}L.esri.Util.debounce=function(a,b){var c=null;return function(){var d=this||d,e=arguments;clearTimeout(c),c=setTimeout(function(){a.apply(d,e)},b)}},L.esri.Util.roundAwayFromZero=function(a){return a>0?Math.ceil(a):Math.floor(a)},L.esri.Util.trim=function(a){return a.replace(/^\s\s*/,"").replace(/\s\s*$/,"")},L.esri.Util.cleanUrl=function(a){return a=L.esri.Util.trim(a),"/"!==a[a.length-1]&&(a+="/"),a},L.esri.Util.serialize=function(a){var b="";for(var c in a)if(a.hasOwnProperty(c)){var d=c,e=a[c];b+=encodeURIComponent(d),b+="=",b+=encodeURIComponent(e),b+="&"}return b.substring(0,b.length-1)},L.esri.Util.indexOf=function(a,b,c){if(c=c||0,a.indexOf)return a.indexOf(b,c);for(var d=c,e=a.length;e>d;d++)if(a[d]===b)return d;return-1},L.esri.Util.extentToBounds=function(a){var b=new L.LatLng(a.ymin,a.xmin),c=new L.LatLng(a.ymax,a.xmax);return new L.LatLngBounds(b,c)},L.esri.Util.mercatorExtentToBounds=function(a,b){var c=b.unproject(L.point([a.ymin,a.xmin])),d=b.unproject(L.point([a.ymax,a.xmax]));return new L.LatLngBounds(c,d)},L.esri.Util.boundsToExtent=function(a){return{xmin:a.getSouthWest().lng,ymin:a.getSouthWest().lat,xmax:a.getNorthEast().lng,ymax:a.getNorthEast().lat,spatialReference:{wkid:4326}}},L.esri.Util.boundsToEnvelope=function(a){var b=L.esri.Util.boundsToExtent(a);return{x:b.xmin,y:b.ymin,w:Math.abs(b.xmin-b.xmax),h:Math.abs(b.ymin-b.ymax)}},L.esri.Util.arcgisToGeojson=function(b,c){var d={};return c=c||{},c.idAttribute=c.idAttribute||void 0,b.x&&b.y&&(d.type="Point",d.coordinates=[b.x,b.y]),b.points&&(d.type="MultiPoint",d.coordinates=b.points.slice(0)),b.paths&&(1===b.paths.length?(d.type="LineString",d.coordinates=b.paths[0].slice(0)):(d.type="MultiLineString",d.coordinates=b.paths.slice(0))),b.rings&&(d=g(b.rings.slice(0))),(b.geometry||b.attributes)&&(d.type="Feature",d.geometry=b.geometry?L.esri.Util.arcgisToGeojson(b.geometry):null,d.properties=b.attributes?a(b.attributes):null,b.attributes&&(d.id=b.attributes[c.idAttribute]||b.attributes.OBJECTID||b.attributes.FID)),d},L.esri.Util.geojsonToArcGIS=function(a,b){var c,d=b&&b.idAttribute?b.idAttribute:"OBJECTID",e=b&&b.sr?{wkid:b.sr}:{wkid:4326},f={};switch(a.type){case"Point":f.x=a.coordinates[0],f.y=a.coordinates[1],f.spatialReference=e;break;case"MultiPoint":f.points=a.coordinates.slice(0),f.spatialReference=e;break;case"LineString":f.paths=[a.coordinates.slice(0)],f.spatialReference=e;break;case"MultiLineString":f.paths=a.coordinates.slice(0),f.spatialReference=e;break;case"Polygon":f.rings=k(a.coordinates.slice(0)),f.spatialReference=e;break;case"MultiPolygon":f.rings=l(a.coordinates.slice(0)),f.spatialReference=e;break;case"Feature":a.geometry&&(f.geometry=L.esri.Util.geojsonToArcGIS(a.geometry,b)),f.attributes=a.properties?L.esri.Util.clone(a.properties):{},f.attributes[d]=a.id;break;case"FeatureCollection":for(f=[],c=0;c<a.features.length;c++)f.push(L.esri.Util.geojsonToArcGIS(a.features[c],b));break;case"GeometryCollection":for(f=[],c=0;c<a.geometries.length;c++)f.push(L.esri.Util.geojsonToArcGIS(a.geometries[c],b))}return f},L.esri.Util.geojsonBounds=function(a){if(a.type)switch(a.type){case"Point":return[a.coordinates[0],a.coordinates[1],a.coordinates[0],a.coordinates[1]];case"MultiPoint":return h(a.coordinates);case"LineString":return h(a.coordinates);case"MultiLineString":return i(a.coordinates);case"Polygon":return i(a.coordinates);case"MultiPolygon":return j(a.coordinates);case"Feature":return a.geometry?L.esri.Util.geojsonBounds(a.geometry):null;default:throw new Error("Unknown type: "+a.type)}return null},L.esri.Util.featureSetToFeatureCollection=function(a){var b;if(a.objectIdFieldName)b=a.objectIdFieldName;else if(a.fields)for(var c=0;c<=a.fields.length-1;c++)if("esriFieldTypeOID"===a.fields[c].type){b=a.fields[c].name;break}var d={type:"FeatureCollection",features:[]};if(a.features.length)for(var e=a.features.length-1;e>=0;e--)d.features.push(L.esri.Util.arcgisToGeojson(a.features[e],{idAttribute:b}));return d}}(L),function(L){function a(a,b){var c=new XMLHttpRequest;return c.onreadystatechange=function(){var d,e;if(4===c.readyState){try{d=JSON.parse(c.responseText)}catch(f){d=null,e={error:"Could not parse response as JSON.",code:500}}!e&&d.error&&(e=d.error,d=null),a.call(b,e,d)}},c}L.esri.RequestHandlers={post:function(b,c,d,e){c.f="json";var f=a(d,e);f.open("POST",b),f.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),f.send(L.esri.Util.serialize(c))},get:{CORS:function(b,c,d,e){c.f="json";var f=a(d,e);f.open("GET",b+"?"+L.esri.Util.serialize(c),!0),f.send(null)},JSONP:function(a,b,c,d){L.esri._callback=L.esri._callback||{};var e="c"+(1e9*Math.random()).toString(36).replace(".","_");b.f="json",b.callback="L.esri._callback."+e;var f=L.DomUtil.create("script",null,document.body);f.type="text/javascript",f.src=a+"?"+L.esri.Util.serialize(b),f.id=e,L.esri._callback[e]=function(a){var b,g=Object.prototype.toString.call(a);"[object Object]"!==g&&"[object Array]"!==g&&(b={code:500,error:"Expected array or object as JSONP response"},a=null),!b&&a.error&&(b=a.error,a=null),c.call(d,b,a),document.body.removeChild(f),delete L.esri._callback[e]}}}},L.esri.get=L.esri.Support.CORS?L.esri.RequestHandlers.get.CORS:L.esri.RequestHandlers.get.JSONP,L.esri.post=L.esri.RequestHandlers.post}(L),L.esri.Services.FeatureServer=L.esri.Service.extend({query:function(){return new L.esri.Services.Query(this)}}),L.esri.Services.featureService=function(a,b){return new L.esri.Services.FeatureService(a,b)},L.esri.Services.FeatureLayer=L.esri.Service.extend({query:function(){return new L.esri.Services.Query(this)},addFeature:function(a,b,c){a=L.esri.Util.geojsonToArcGIS(a),this.post(this.url+"addFeatures",JSON.stringify(a),b,c)},updateFeature:function(a,b,c){a=L.esri.Util.geojsonToArcGIS(a),this.post(this.url+"updateFeatures",JSON.stringify(a),b,c)},deleteFeature:function(a,b,c){this.post(this.url+"deleteFeatures",{objectIds:a},b,c)}}),L.esri.Services.featureLayer=function(a,b){return new L.esri.Services.FeatureLayer(a,b)},L.esri.Services.Query=L.Class.extend({initialize:function(a,b){a.url&&a.get?(this._service=a,this.url=a.url):this.url=a,this._params={outSr:4326};for(var c in b)b.hasOwnProperty(c)&&b.key&&this[c].apply(this,b[c])},within:function(a){return this._params.geometry=JSON.stringify(L.esri.Util.boundsToExtent(a)),this._params.geometryType="esriGeometryEnvelope",this._params.spatialRel="esriSpatialRelIntersects",this},intersects:function(a){return this._params.geometry=JSON.stringify(L.esri.Util.geojsonToArcGIS(a.toGeoJSON())),this._params.geometryType="esriGeometryPolyline",this._params.spatialRel="esriSpatialRelIntersects",this},around:function(a,b){return this._params.geometry=[a.lng,a.lat].join(","),this._params.geometryType="esriGeometryPoint",this._params.spatialRel="esriSpatialRelIntersects",this._params.units="esriSRUnit_Meter",this._params.distance=b,this._params.inSr=4326,this},layerDef:function(a,b){return this._params.layerDefs=this._params.layerDefs?this._params.layerDefs+";":"",this._params.layerDefs+=[a,b].join(":"),this},where:function(a){return this._params.where=a,this},offset:function(a){return this._params.offset=a,this},limit:function(a){return this._params.limit=a,this},between:function(a,b){return this._params.time=[a.valueOf(),b.valueOf()].join(),this},fields:function(a){return this._params.outFields=a.join(","),this},precision:function(a){return this._params.geometryPrecision=a,this},simplify:function(a,b){var c=Math.abs(a.getBounds().getWest()-a.getBounds().getEast());return this._params.maxAllowableOffset=c/a.getSize().y*b,this},orderBy:function(a,b){return this._params.orderByFields=this._params.orderByFields?this._params.orderByFields+",":"",this._params.orderByFields+=[a,b||"ASC"].join(","),this},featureIds:function(a){return this._params.objectIds=a.join(","),this},token:function(a){return this._params.token=a,this},run:function(a,b){this._request(function(c,d){var e=L.esri.Util.featureSetToFeatureCollection(d);a.call(b,c,e)},b)},count:function(a,b){this._params.returnCountOnly=!0,this._request(a,b)},ids:function(a,b){this._params.returnIdsOnly=!0,this._request(a,b)},bounds:function(a,b){this._params.returnExtentOnly=!0,this._request(a,b)},_request:function(a,b){this._service?this._service.get("query",this._params,a,b):L.esri.get(this.url,this._params,a,b)}}),L.esri.Services.query=function(a,b){return new L.esri.Services.Query(a,b)},function(L){"use strict";function a(b,c){return this instanceof a?(this._maxEntries=Math.max(4,b||9),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),c&&this._initFormat(c),this.clear(),void 0):new a(b,c)}a.prototype={all:function(){return this._all(this.data,[])},search:function(a){var b=this.data,c=[];if(!this._intersects(a,b.bbox))return c;for(var d,e,f,g,h=[];b;){for(d=0,e=b.children.length;e>d;d++)f=b.children[d],g=b.leaf?this.toBBox(f):f.bbox,this._intersects(a,g)&&(b.leaf?c.push(f):this._contains(a,g)?this._all(f,c):h.push(f));b=h.pop()}return c},load:function(a){if(!a||!a.length)return this;if(a.length<this._minEntries){for(var b=0,c=a.length;c>b;b++)this.insert(a[b]);return this}var d=this._build(a.slice(),0);if(this.data.children.length)if(this.data.height===d.height)this._splitRoot(this.data,d);else{if(this.data.height<d.height){var e=this.data;this.data=d,d=e}this._insert(d,this.data.height-d.height-1,!0)}else this.data=d;return this},insert:function(a){return a&&this._insert(a,this.data.height-1),this},clear:function(){return this.data={children:[],leaf:!0,bbox:this._empty(),height:1},this},remove:function(a){if(!a)return this;for(var b,c,d,e,f=this.data,g=this.toBBox(a),h=[],i=[];f||h.length;){if(f||(f=h.pop(),c=h[h.length-1],b=i.pop(),e=!0),f.leaf&&(d=f.children.indexOf(a),-1!==d))return f.children.splice(d,1),h.push(f),this._condense(h),this;e||f.leaf||!this._intersects(g,f.bbox)?c?(b++,f=c.children[b],e=!1):f=null:(h.push(f),i.push(b),b=0,c=f,f=f.children[0])}return this},toBBox:function(a){return a},compareMinX:function(a,b){return a[0]-b[0]},compareMinY:function(a,b){return a[1]-b[1]},toJSON:function(){return this.data},fromJSON:function(a){return this.data=a,this},_all:function(a,b){for(var c=[];a;)a.leaf?b.push.apply(b,a.children):c.push.apply(c,a.children),a=c.pop();return b},_build:function(a,b,c){var d,e=a.length,f=this._maxEntries;if(f>=e)return d={children:a,leaf:!0,height:1},this._calcBBox(d),d;b||(c=Math.ceil(Math.log(e)/Math.log(f)),f=Math.ceil(e/Math.pow(f,c-1)),a.sort(this.compareMinX)),d={children:[],height:c};var g,h,i,j,k,l=Math.ceil(e/f)*Math.ceil(Math.sqrt(f)),m=Math.ceil(e/f),n=1===b%2?this.compareMinX:this.compareMinY;for(g=0;e>g;g+=l)for(i=a.slice(g,g+l).sort(n),h=0,j=i.length;j>h;h+=m)k=this._build(i.slice(h,h+m),b+1,c-1),d.children.push(k);return this._calcBBox(d),d},_chooseSubtree:function(a,b,c,d){for(var e,f,g,h,i,j,k,l;;){if(d.push(b),b.leaf||d.length-1===c)break;for(k=l=1/0,e=0,f=b.children.length;f>e;e++)g=b.children[e],i=this._area(g.bbox),j=this._enlargedArea(a,g.bbox)-i,l>j?(l=j,k=k>i?i:k,h=g):j===l&&k>i&&(k=i,h=g);b=h}return b},_insert:function(a,b,c,d){var e,f=c?a.bbox:this.toBBox(a),g=[],h=this._chooseSubtree(f,d||this.data,b,g);h.children.push(a),this._extend(h.bbox,f);do e=!1,g[b].children.length>this._maxEntries&&(this._split(g,b),e=!0,b--);while(b>=0&&e);this._adjustParentBBoxes(f,g,b)},_split:function(a,b){var c=a[b],d=c.children.length,e=this._minEntries;this._chooseSplitAxis(c,e,d);var f={children:c.children.splice(this._chooseSplitIndex(c,e,d)),height:c.height};c.leaf&&(f.leaf=!0),this._calcBBox(c),this._calcBBox(f),b?a[b-1].children.push(f):this._splitRoot(c,f)},_splitRoot:function(a,b){this.data={},this.data.children=[a,b],this.data.height=a.height+1,this._calcBBox(this.data)},_chooseSplitIndex:function(a,b,c){var d,e,f,g,h,i,j,k;for(i=j=1/0,d=b;c-b>=d;d++)e=this._distBBox(a,0,d),f=this._distBBox(a,d,c),g=this._intersectionArea(e,f),h=this._area(e)+this._area(f),i>g?(i=g,k=d,j=j>h?h:j):g===i&&j>h&&(j=h,k=d);return k},_chooseSplitAxis:function(a,b,c){var d=a.leaf?this.compareMinX:this._compareNodeMinX,e=a.leaf?this.compareMinY:this._compareNodeMinY,f=this._allDistMargin(a,b,c,d),g=this._allDistMargin(a,b,c,e);g>f&&a.children.sort(d)},_allDistMargin:function(a,b,c,d){a.children.sort(d);var e,f,g=this._distBBox(a,0,b),h=this._distBBox(a,c-b,c),i=this._margin(g)+this._margin(h);for(e=b;c-b>e;e++)f=a.children[e],this._extend(g,a.leaf?this.toBBox(f):f.bbox),i+=this._margin(g);for(e=c-b-1;e>=0;e--)f=a.children[e],this._extend(h,a.leaf?this.toBBox(f):f.bbox),i+=this._margin(h);return i},_distBBox:function(a,b,c){for(var d,e=this._empty(),f=b;c>f;f++)d=a.children[f],this._extend(e,a.leaf?this.toBBox(d):d.bbox);return e},_calcBBox:function(a){a.bbox=this._empty();for(var b,c=0,d=a.children.length;d>c;c++)b=a.children[c],this._extend(a.bbox,a.leaf?this.toBBox(b):b.bbox)},_adjustParentBBoxes:function(a,b,c){for(var d=c;d>=0;d--)this._extend(b[d].bbox,a)},_condense:function(a){for(var b,c=a.length-1;c>=0;c--)0===a[c].children.length?c>0?(b=a[c-1].children,b.splice(b.indexOf(a[c]),1)):this.clear():this._calcBBox(a[c])},_contains:function(a,b){return a[0]<=b[0]&&a[1]<=b[1]&&b[2]<=a[2]&&b[3]<=a[3]},_intersects:function(a,b){return b[0]<=a[2]&&b[1]<=a[3]&&b[2]>=a[0]&&b[3]>=a[1]},_extend:function(a,b){return a[0]=Math.min(a[0],b[0]),a[1]=Math.min(a[1],b[1]),a[2]=Math.max(a[2],b[2]),a[3]=Math.max(a[3],b[3]),a},_area:function(a){return(a[2]-a[0])*(a[3]-a[1])},_margin:function(a){return a[2]-a[0]+(a[3]-a[1])},_enlargedArea:function(a,b){return(Math.max(b[2],a[2])-Math.min(b[0],a[0]))*(Math.max(b[3],a[3])-Math.min(b[1],a[1]))},_intersectionArea:function(a,b){var c=Math.max(a[0],b[0]),d=Math.max(a[1],b[1]),e=Math.min(a[2],b[2]),f=Math.min(a[3],b[3]);return Math.max(0,e-c)*Math.max(0,f-d)},_empty:function(){return[1/0,1/0,-1/0,-1/0]},_compareNodeMinX:function(a,b){return a.bbox[0]-b.bbox[0]},_compareNodeMinY:function(a,b){return a.bbox[1]-b.bbox[1]},_initFormat:function(a){var b=["return a"," - b",";"];this.compareMinX=new Function("a","b",b.join(a[0])),this.compareMinY=new Function("a","b",b.join(a[1])),this.toBBox=new Function("a","return [a"+a.join(", a")+"];")}},L.esri._rbush=a}(L),L.esri.FeatureGrid=L.Layer.extend({options:{cellSize:512,updateInterval:150},initialize:function(a){a=L.setOptions(this,a)},onAdd:function(){this._update=L.Util.throttle(this._update,this.options.updateInterval,this),this._reset(),this._update()},onRemove:function(){this._removeCells()},getEvents:function(){var a={viewreset:this._reset,moveend:this._update};return a},_reset:function(){this._removeCells(),this._cells={},this._activeCells={},this._cellsToLoad=0,this._cellsTotal=0,this._cellNumBounds=this._getCellNumBounds(),this._resetWrap()},_resetWrap:function(){var a=this._map,b=a.options.crs;if(!b.infinite){var c=this._getCellSize();b.wrapLng&&(this._wrapLng=[Math.floor(a.project([0,b.wrapLng[0]]).x/c),Math.ceil(a.project([0,b.wrapLng[1]]).x/c)]),b.wrapLat&&(this._wrapLat=[Math.floor(a.project([b.wrapLat[0],0]).y/c),Math.ceil(a.project([b.wrapLat[1],0]).y/c)])}},_getCellSize:function(){return this.options.cellSize},_update:function(){if(this._map){var a=this._map.getPixelBounds(),b=this._map.getZoom(),c=this._getCellSize();if(!(b>this.options.maxZoom||b<this.options.minZoom)){var d=L.bounds(a.min.divideBy(c).floor(),a.max.divideBy(c).floor());this._addCells(d),this._removeOtherCells(d)}}},_addCells:function(a){var b,c,d,e=[],f=a.getCenter(),g=this._map.getZoom();for(b=a.min.y;b<=a.max.y;b++)for(c=a.min.x;c<=a.max.x;c++)d=new L.Point(c,b),d.z=g,this._isValidCell(d)&&e.push(d);var h=e.length;if(0!==h)for(this._cellsToLoad+=h,this._cellsTotal+=h,e.sort(function(a,b){return a.distanceTo(f)-b.distanceTo(f)}),c=0;h>c;c++)this._addCell(e[c])},_isValidCell:function(a){var b=this._map.options.crs;if(!b.infinite){var c=this._cellNumBounds;if(!b.wrapLng&&(a.x<c.min.x||a.x>c.max.x)||!b.wrapLat&&(a.y<c.min.y||a.y>c.max.y))return!1}if(!this.options.bounds)return!0;var d=this._cellCoordsToBounds(a);return L.latLngBounds(this.options.bounds).intersects(d)},_cellCoordsToBounds:function(a){var b=this._map,c=this.options.cellSize,d=a.multiplyBy(c),e=d.add([c,c]),f=b.wrapLatLng(b.unproject(d,a.z)),g=b.wrapLatLng(b.unproject(e,a.z));return new L.LatLngBounds(f,g)},_cellCoordsToKey:function(a){return a.x+":"+a.y},_keyToCellCoords:function(a){var b=a.split(":"),c=parseInt(b[0],10),d=parseInt(b[1],10);return new L.Point(c,d)},_removeOtherCells:function(a){for(var b in this._cells)a.contains(this._keyToCellCoords(b))||this._removeCell(b)},_removeCell:function(a){var b=this._activeCells[a];b&&(delete this._activeCells[a],this.cellLeave&&this.cellLeave(b.bounds,b.coords),this.fire("cellleave",{bounds:b.bounds,coords:b.coords}))},_removeCells:function(){for(var a in this._cells){var b=this._cells[a].bounds,c=this._cells[a].coords;this.cellLeave&&this.cellLeave(b,c),this.fire("cellleave",{bounds:b,coords:c})}},_addCell:function(a){this._wrapCoords(a);var b=this._cellCoordsToKey(a),c=this._cells[b];c&&!this._activeCells[b]&&(this.cellEnter&&this.cellEnter(c.bounds,a),this.fire("cellenter",{bounds:c.bounds,coords:a}),this._activeCells[b]=c),c||(c={coords:a,bounds:this._cellCoordsToBounds(a)},this._cells[b]=c,this._activeCells[b]=c,this.createCell&&this.createCell(c.bounds,a),this.fire("cellcreate",{bounds:c.bounds,coords:a}))},_wrapCoords:function(a){a.x=this._wrapLng?L.Util.wrapNum(a.x,this._wrapLng):a.x,a.y=this._wrapLat?L.Util.wrapNum(a.y,this._wrapLat):a.y},_getCellNumBounds:function(){var a=this._map.getPixelWorldBounds(),b=this._getCellSize();return a?L.bounds(a.min.divideBy(b).floor(),a.max.divideBy(b).ceil().subtract([1,1])):null}}),L.esri.featureGrid=function(a){return new L.esri.FeatureGrid(a)},function(L){function a(a){this.values=a||[]}L.esri.FeatureManager=L.esri.FeatureGrid.extend({options:{where:"1=1",fields:["*"],from:!1,to:!1,timeField:!1,timeFilterMode:"server",simplifyFactor:0},initialize:function(b,c){L.esri.FeatureGrid.prototype.initialize.call(this,c),c=L.setOptions(this,c),this.url=L.esri.Util.cleanUrl(b),this._timeEnabled=!(!c.from||!c.to),this._service=new L.esri.Services.FeatureLayer(this.url),this._timeEnabled&&(this.timeIndex=new a),this._currentSnapshot=[],this._activeRequests=0},onAdd:function(){L.esri.FeatureGrid.prototype.onAdd.call(this)},onRemove:function(){L.esri.FeatureGrid.prototype.onRemove.call(this)},createCell:function(a){this._requestFeatures(a)},_requestFeatures:function(a,b){this._activeRequests++,1===this._activeRequests&&this.fire("loading",{bounds:a}),this._buildQuery(a).run(function(c,d){this._activeRequests--,d.features.length&&this._addFeatures(d.features),b&&b.call(this,d.features),this._activeRequests<=0&&this.fire("load",{bounds:a})},this)},_addFeatures:function(a){for(var b=a.length-1;b>=0;b--)this._currentSnapshot.push(a[b].id);this._timeEnabled&&this._buildTimeIndexes(a),this.createLayers(a)},_buildQuery:function(a){var b=this._service.query().within(a).where(this.options.where).fields(this.options.fields);return this.options.simplifyFactor&&b.simplify(this._map,this.options.simplifyFactor),"server"===this.options.timeFilterMode&&this.options.from&&this.options.to&&b.between(this.options.from,this.options.to),b},setWhere:function(a,b){this.options.where=a&&a.length?a:"1=1";for(var c=[],d=this._currentSnapshot.length-1;d>=0;d--)c.push(this._currentSnapshot[d]);this._requestFeatures(this._map.getBounds(),function(a){for(var d=[],e=a.length-1;e>=0;e--)d.push(a[e].id);var f=this._diffLayerState(c,d);this._currentSnapshot=f.newFeatures,this.removeLayers(f.oldFeatures),this.addLayers(f.newFeatures),b&&b.call(this)})},getWhere:function(){return this.options.where},getTimeRange:function(){return[this.options.from,this.options.to]},setTimeRange:function(a,b){var c=this.options.from,d=this.options.to;this.options.from=a,this.options.to=b,this._filterExistingFeatures(c,d,a,b),"server"===this.options.timeFilterMode&&this._requestFeatures(this._map.getBounds(),L.Util.bind(function(){this._filterExistingFeatures(c,d,a,b)},this))},_diffLayerState:function(a,b){for(var c=[],d=a.length-1;d>=0;d--){var e=b.indexOf(a[d]);e>=0&&c.push(e)}for(d=c.length-1;d>=0;d--)a.splice(c[d],1),b.splice(c[d],1);return{oldFeatures:a,newFeatures:b}},_filterExistingFeatures:function(a,b,c,d){var e=this._getFeaturesInTimeRange(a,b),f=this._getFeaturesInTimeRange(c,d),g=this._diffLayerState(e,f);this._currentSnapshot=g.newFeatures,this.removeLayers(g.oldFeatures),this.addLayers(g.newFeatures)},_getFeaturesInTimeRange:function(a,b){var c,d=[];if(this.options.timeField.start&&this.options.timeField.end){var e=this.timeIndex.between(a,b,this.options.timeField.start),f=this.timeIndex.between(a,b,this.options.timeField.end);c=e.concat(f)}else c=this.timeIndex.between(a,b,this.options.timeField);for(var g=c.length-1;g>=0;g--)d.push(c[g].id);return d},_buildTimeIndexes:function(a){for(var b=[],c=a.length-1;c>=0;c--)b.push(this._createTimeEntry(a[c]));this.timeIndex.add(b)},_createTimeEntry:function(a){var b={id:a.id};return this.options.timeField.start&&this.options.timeField.end?(b.start=new Date(a.properties[this.options.timeField.start]),b.end=new Date(a.properties[this.options.timeField.end])):b.date=new Date(a.properties[this.options.timeField]),b},_featureWithinTimeRange:function(a){if(!this.options.timeField||!this.options.from||!this.options.to)return!0;var b=this.options.from.valueOf(),c=this.options.to.valueOf();if("string"==typeof this.options.timeField){var d=a.properties[this.options.timeField];return d>b&&c>d}if(this.options.timeField.from&&this.options.timeField.to){var e=a.properties[this.options.timeField.from],f=a.properties[this.options.timeField.to];return e>b&&c>e||f>b&&c>f}}}),L.esri.featureManager=function(a){return new L.esri.FeatureManager(a)},a.prototype._query=function(a,b){"[object Date]"===Object.prototype.toString.call(b)&&(b=b.valueOf());for(var c,d,e,f=0,g=this.values.length-1;g>=f;)if(e=c=(f+g)/2||0,d=this.values[c],d[a]<b)f=c+1;else{if(!(d[a]>b))return c;g=c-1}return Math.abs(g)},a.prototype.query=function(a,b){return this.sortOn(a),this._query(a,b)},a.prototype.sortOn=function(a){this.lastKey!==a&&(this.lastKey=a,this.values.sort(function(b,c){return b[a]-c[a]}))},a.prototype.between=function(a,b,c){this.sortOn(c);var d=this._query(c,a),e=this._query(c,b);return this.values.slice(d,e)},a.prototype.add=function(a){this.values=this.values.concat(a)}}(L),L.esri.FeatureLayer=L.esri.FeatureManager.extend({initialize:function(a,b){L.esri.FeatureManager.prototype.initialize.call(this,a,b),this.index=L.esri._rbush(),b=L.setOptions(this,b),this._layers={}},createLayers:function(a){for(var b=[],c=a.length-1;c>=0;c--){var d,e=a[c],f=this._layers[e.id];if(f&&!this._map.hasLayer(f)&&this._map.addLayer(f),f&&f.setLatLngs&&(d=L.GeoJSON.geometryToLayer(e,this.options),f.setLatLngs(d.getLatLngs())),!f){d=L.GeoJSON.geometryToLayer(e,this.options),d.feature=L.GeoJSON.asFeature(e);var g=L.esri.Util.geojsonBounds(d.feature);g.push(d.feature.id),b.push(g),d.defaultOptions=d.options,this.resetStyle(d),d.addEventParent(this),this._popup&&d.bindPopup(this._popup(d.feature,d)),this._layers[d.feature.id]=d,(!this._timeEnabled||this._timeEnabled&&this._featureWithinTimeRange(e))&&this._map.addLayer(d)}}this.index.load(b)},cellEnter:function(a){for(var b=this._featuresWithinBounds(a),c=b.length-1;c>=0;c--){var d=b[c];d.addTo(this._map)}},cellLeave:function(a){for(var b=this._featuresWithinBounds(a),c=b.length-1;c>=0;c--){var d=b[c];!d.getBounds||a.contains(d.getBounds())||a.intersects(d.getBounds())||d.removeFrom(this._map),d.getLatLng&&!a.contains(d.getLatLng())&&d.removeFrom(this._map)}},addLayers:function(a){for(var b=a.length-1;b>=0;b--){var c=this._layers[a[b]];c&&c.addTo(this._map)}},removeLayers:function(a){for(var b=a.length-1;b>=0;b--){var c=this._layers[a[b]];c&&c.removeFrom(this._map)}},resetStyle:function(a){a.options=a.defaultOptions,this._setLayerStyle(a,this.options.style)},setStyle:function(a){this.eachLayer(function(b){this._setLayerStyle(b,a)},this)},_setLayerStyle:function(a,b){"function"==typeof b&&(b=b(a.feature)),a.setStyle&&a.setStyle(b)},bindPopup:function(a,b){this._popup=a;for(var c in this._layers){var d=this._layers[c],e=this._popup(d.feature,d);d.bindPopup(e,b)}},unbindPopup:function(){this._popup=!1;for(var a in this._layers)this._layers[a].unbindPopup()},eachFeature:function(a,b){for(var c in this._layers)a.call(b,this._layers[c]);return this},getFeature:function(a){return this._layers[a]},_featuresWithinBounds:function(a){var b,c=this.index.search(a.toBBoxString().split(",")),d=[],e=[];for(b=c.length-1;b>=0;b--)d.push(c[b][4]);for(b=d.length-1;b>=0;b--)e.push(this._layers[d[b]]);return e}}),L.esri.featureLayer=function(a){return new L.esri.FeatureLayer(a)};