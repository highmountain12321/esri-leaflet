/*! esri-leaflet - v0.0.1-beta.5 - 2014-07-23
*   Copyright (c) 2014 Environmental Systems Research Institute, Inc.
*   Apache License*/
L.esri={VERSION:"0.0.1-beta.5",Layers:{},Services:{},Controls:{},Tasks:{},Util:{},Support:{CORS:!!(window.XMLHttpRequest&&"withCredentials"in new XMLHttpRequest),pointerEvents:""===document.documentElement.style.pointerEvents}},function(L){function a(a){var b={};for(var c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);return b}function b(a){return c(a[0],a[a.length-1])||a.push(a[0]),a}function c(a,b){for(var c=0;c<a.length;c++)if(a[c]!==b[c])return!1;return!0}function d(a){var b,c=0,d=0,e=a.length,f=a[d];for(d;e-1>d;d++)b=a[d+1],c+=(b[0]-f[0])*(b[1]+f[1]),f=b;return c>=0}function e(a,b,c,d){var e=(d[0]-c[0])*(a[1]-c[1])-(d[1]-c[1])*(a[0]-c[0]),f=(b[0]-a[0])*(a[1]-c[1])-(b[1]-a[1])*(a[0]-c[0]),g=(d[1]-c[1])*(b[0]-a[0])-(d[0]-c[0])*(b[1]-a[1]);if(0!==g){var h=e/g,i=f/g;if(h>=0&&1>=h&&i>=0&&1>=i)return!0}return!1}function f(a,b){for(var c=0;c<a.length-1;c++)for(var d=0;d<b.length-1;d++)if(e(a[c],a[c+1],b[d],b[d+1]))return!0;return!1}function g(a,b){for(var c=!1,d=-1,e=a.length,f=e-1;++d<e;f=d)(a[d][1]<=b[1]&&b[1]<a[f][1]||a[f][1]<=b[1]&&b[1]<a[d][1])&&b[0]<(a[f][0]-a[d][0])*(b[1]-a[d][1])/(a[f][1]-a[d][1])+a[d][0]&&(c=!c);return c}function h(a,b){var c=f(a,b),d=g(a,b[0]);return!c&&d?!0:!1}function i(a){for(var c=[],e=[],f=0;f<a.length;f++){var g=b(a[f].slice(0));if(!(g.length<4))if(d(g)){var i=[g];c.push(i)}else e.push(g)}for(;e.length;){for(var j=e.pop(),k=!1,l=c.length-1;l>=0;l--){var m=c[l][0];if(h(m,j)){c[l].push(j),k=!0;break}}k||c.push([j.reverse()])}return 1===c.length?{type:"Polygon",coordinates:c[0]}:{type:"MultiPolygon",coordinates:c}}function j(a){var c=[],e=a.slice(0),f=b(e.shift().slice(0));if(f.length>=4){d(f)||f.reverse(),c.push(f);for(var g=0;g<e.length;g++){var h=b(e[g].slice(0));h.length>=4&&(d(h)&&h.reverse(),c.push(h))}}return c}function k(a){for(var b=[],c=0;c<a.length;c++)for(var d=j(a[c]),e=d.length-1;e>=0;e--){var f=d[e].slice(0);b.push(f)}return b}L.esri.Util.extentToBounds=function(a){var b=new L.LatLng(a.ymin,a.xmin),c=new L.LatLng(a.ymax,a.xmax);return new L.LatLngBounds(b,c)},L.esri.Util.boundsToExtent=function(a){return{xmin:a.getSouthWest().lng,ymin:a.getSouthWest().lat,xmax:a.getNorthEast().lng,ymax:a.getNorthEast().lat,spatialReference:{wkid:4326}}},L.esri.Util.arcgisToGeojson=function(b,c){var d={};return"number"==typeof b.x&&"number"==typeof b.y&&(d.type="Point",d.coordinates=[b.x,b.y]),b.points&&(d.type="MultiPoint",d.coordinates=b.points.slice(0)),b.paths&&(1===b.paths.length?(d.type="LineString",d.coordinates=b.paths[0].slice(0)):(d.type="MultiLineString",d.coordinates=b.paths.slice(0))),b.rings&&(d=i(b.rings.slice(0))),(b.geometry||b.attributes)&&(d.type="Feature",d.geometry=b.geometry?L.esri.Util.arcgisToGeojson(b.geometry):null,d.properties=b.attributes?a(b.attributes):null,b.attributes&&(d.id=b.attributes[c]||b.attributes.OBJECTID||b.attributes.FID)),d},L.esri.Util.geojsonToArcGIS=function(b,c){c=c||"OBJECTID";var d,e={wkid:4326},f={};switch(b.type){case"Point":f.x=b.coordinates[0],f.y=b.coordinates[1],f.spatialReference=e;break;case"MultiPoint":f.points=b.coordinates.slice(0),f.spatialReference=e;break;case"LineString":f.paths=[b.coordinates.slice(0)],f.spatialReference=e;break;case"MultiLineString":f.paths=b.coordinates.slice(0),f.spatialReference=e;break;case"Polygon":f.rings=j(b.coordinates.slice(0)),f.spatialReference=e;break;case"MultiPolygon":f.rings=k(b.coordinates.slice(0)),f.spatialReference=e;break;case"Feature":b.geometry&&(f.geometry=L.esri.Util.geojsonToArcGIS(b.geometry,c)),f.attributes=b.properties?a(b.properties):{},b.id&&(f.attributes[c]=b.id);break;case"FeatureCollection":for(f=[],d=0;d<b.features.length;d++)f.push(L.esri.Util.geojsonToArcGIS(b.features[d],c));break;case"GeometryCollection":for(f=[],d=0;d<b.geometries.length;d++)f.push(L.esri.Util.geojsonToArcGIS(b.geometries[d],c))}return f},L.esri.Util.responseToFeatureCollection=function(a,b){var c;if(b)c=b;else if(a.objectIdFieldName)c=a.objectIdFieldName;else if(a.fields){for(var d=0;d<=a.fields.length-1;d++)if("esriFieldTypeOID"===a.fields[d].type){c=a.fields[d].name;break}}else c="OBJECTID";var e={type:"FeatureCollection",features:[]},f=a.features||a.results;if(f.length)for(var g=f.length-1;g>=0;g--)e.features.push(L.esri.Util.arcgisToGeojson(f[g],c));return e},L.esri.Util.cleanUrl=function(a){return a=a.replace(/\s\s*/g,""),"/"!==a[a.length-1]&&(a+="/"),a}}(L),function(L){function a(a){var b="";a.f="json";for(var c in a)if(a.hasOwnProperty(c)){var d,e=a[c],f=Object.prototype.toString.call(e);b.length&&(b+="&"),d="[object Array]"===f||"[object Object]"===f?JSON.stringify(e):"[object Date]"===f?e.valueOf():e,b+=encodeURIComponent(c)+"="+encodeURIComponent(d)}return b}function b(a,b){var c=new XMLHttpRequest;return c.onerror=function(){a.call(b,{error:{code:500,message:"XMLHttpRequest error"}},null)},c.onreadystatechange=function(){var d,e;if(4===c.readyState){try{d=JSON.parse(c.responseText)}catch(f){d=null,e={code:500,message:"Could not parse response as JSON."}}!e&&d.error&&(e=d.error,d=null),a.call(b,e,d)}},c}var c=0;L.esri.Request={post:{XMLHTTP:function(c,d,e,f){var g=b(e,f);return g.open("POST",c),g.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),g.send(a(d)),g}},get:{CORS:function(c,d,e,f){var g=b(e,f);return g.open("GET",c+"?"+a(d),!0),g.send(null),g},JSONP:function(b,d,e,f){L.esri._callback=L.esri._callback||{};var g="c"+c;d.callback="L.esri._callback."+g;var h=L.DomUtil.create("script",null,document.body);return h.type="text/javascript",h.src=b+"?"+a(d),h.id=g,L.esri._callback[g]=function(a){if(L.esri._callback[g]!==!0){var b,c=Object.prototype.toString.call(a);"[object Object]"!==c&&"[object Array]"!==c&&(b={error:{code:500,message:"Expected array or object as JSONP response"}},a=null),!b&&a.error&&(b=a,a=null),e.call(f,b,a),L.esri._callback[g]=!0}},c++,L.esri._callback[g]}}},L.esri.get=L.esri.Support.CORS?L.esri.Request.get.CORS:L.esri.Request.get.JSONP,L.esri.post=L.esri.Request.post.XMLHTTP}(L),L.esri.Services.Service=L.Class.extend({includes:L.Mixin.Events,options:{proxy:!1,useCors:!0},initialize:function(a,b){this.url=L.esri.Util.cleanUrl(a),this._requestQueue=[],this._authenticating=!1,L.Util.setOptions(this,b)},get:function(a,b,c,d){return this._request("get",a,b,c,d)},post:function(a,b,c,d){return this._request("post",a,b,c,d)},metadata:function(a,b){return this._request("get","",{},a,b)},authenticate:function(a){return this._authenticating=!1,this.options.token=a,this._runQueue(),this},_request:function(a,b,c,d,e){this.fire("requeststart",{url:this.url+b,params:c,method:a});var f=this._createServiceCallback(a,b,c,d,e);if(this.options.token&&(c.token=this.options.token),!this._authenticating){var g=this.options.proxy?this.options.proxy+"?"+this.url+b:this.url+b;return"get"!==a||this.options.useCors?L.esri[a](g,c,f):L.esri.Request.get.JSONP(g,c,f)}this._requestQueue.push([a,b,c,d,e])},_createServiceCallback:function(a,b,c,d,e){var f=[a,b,c,d,e];return L.Util.bind(function(g,h){!g||499!==g.code&&498!==g.code?(d.call(e,g,h),g?this.fire("requesterror",{url:this.url+b,params:c,message:g.message,code:g.code,method:a}):this.fire("requestsuccess",{url:this.url+b,params:c,response:h,method:a}),this.fire("requestend",{url:this.url+b,params:c,method:a})):(this._authenticating=!0,this._requestQueue.push(f),this.fire("authenticationrequired",{authenticate:L.Util.bind(this.authenticate,this)}))},this)},_runQueue:function(){for(var a=this._requestQueue.length-1;a>=0;a--){var b=this._requestQueue[a],c=b.shift();this[c].apply(this,b)}this._requestQueue=[]}}),L.esri.Services.service=function(a,b){return new L.esri.Services.Service(a,b)},L.esri.Services.MapService=L.esri.Services.Service.extend({identify:function(){return new L.esri.Tasks.Identify(this)},find:function(){return new L.esri.Tasks.Find(this)},query:function(){return new L.esri.Tasks.Query(this)}}),L.esri.Services.mapService=function(a,b){return new L.esri.Services.MapService(a,b)},L.esri.Services.ImageService=L.esri.Services.Service.extend({query:function(){return new L.esri.Tasks.Query(this)}}),L.esri.Services.imageService=function(a,b){return new L.esri.Services.ImageService(a,b)},L.esri.Tasks.Identify=L.Class.extend({initialize:function(a){a.url&&a.get?(this._service=a,this.url=a.url):this.url=L.esri.Util.cleanUrl(a),this._params={sr:4326,layers:"all",tolerance:3,returnGeometry:!0}},on:function(a){var b=L.esri.Util.boundsToExtent(a.getBounds()),c=a.getSize();return this._params.imageDisplay=[c.x,c.y,96].join(","),this._params.mapExtent=[b.xmin,b.ymin,b.xmax,b.ymax].join(","),this},at:function(a){return this._params.geometry=[a.lng,a.lat].join(","),this._params.geometryType="esriGeometryPoint",this},layerDef:function(a,b){return this._params.layerDefs=this._params.layerDefs?this._params.layerDefs+";":"",this._params.layerDefs+=[a,b].join(":"),this},between:function(a,b){return this._params.time=[a.valueOf(),b.valueOf()].join(","),this},layers:function(a){return this._params.layers=a,this},precision:function(a){return this._params.geometryPrecision=a,this},returnGeometry:function(a){return this._params.returnGeometry=a,this},simplify:function(a,b){var c=Math.abs(a.getBounds().getWest()-a.getBounds().getEast());return this._params.maxAllowableOffset=c/a.getSize().y*(1-b),this},token:function(a){return this._params.token=a,this},tolerance:function(a){return this._params.tolerance=a,this},run:function(a,b){this._request(function(c,d){a.call(b,c,d&&L.esri.Util.responseToFeatureCollection(d),d)},b)},_request:function(a,b){this._service?this._service.get("identify",this._params,a,b):L.esri.get(this.url+"identify",this._params,a,b)}}),L.esri.Tasks.identify=function(a,b){return new L.esri.Tasks.Identify(a,b)},L.esri.Tasks.Query=L.Class.extend({initialize:function(a){a.url&&a.get?(this._service=a,this.url=a.url):this.url=L.esri.Util.cleanUrl(a),this._originalUrl=this.url,this._urlPrefix="",this._params={returnGeometry:!0,where:"1=1",outSr:4326,outFields:"*"}},within:function(a){return this._params.geometry=L.esri.Util.boundsToExtent(a),this._params.geometryType="esriGeometryEnvelope",this._params.spatialRel="esriSpatialRelIntersects",this._params.inSr=4326,this},nearby:function(a,b){return this._params.geometry=[a.lng,a.lat].join(","),this._params.geometryType="esriGeometryPoint",this._params.spatialRel="esriSpatialRelIntersects",this._params.units="esriSRUnit_Meter",this._params.distance=b,this._params.inSr=4326,this},where:function(a){return this._params.where=a.replace(/"/g,"'"),this},offset:function(a){return this._params.offset=a,this},limit:function(a){return this._params.limit=a,this},between:function(a,b){return this._params.time=[a.valueOf(),b.valueOf()].join(),this},fields:function(a){return this._params.outFields=L.Util.isArray(a)?a.join(","):a,this},precision:function(a){return this._params.geometryPrecision=a,this},returnGeometry:function(a){return this._params.returnGeometry=a,this},simplify:function(a,b){var c=Math.abs(a.getBounds().getWest()-a.getBounds().getEast());return this._params.maxAllowableOffset=c/a.getSize().y*b,this},orderBy:function(a,b){return b=b||"ASC",this._params.orderByFields=this._params.orderByFields?this._params.orderByFields+",":"",this._params.orderByFields+=[a,b].join(" "),this},featureIds:function(a){return this._params.objectIds=a.join(","),this},token:function(a){return this._params.token=a,this},run:function(a,b){return this._cleanParams(),this._request(function(c,d){a.call(b,c,d&&L.esri.Util.responseToFeatureCollection(d),d)},b),this},count:function(a,b){return this._cleanParams(),this._params.returnCountOnly=!0,this._request(function(b,c){a.call(this,b,c&&c.count,c)},b),this},ids:function(a,b){return this._cleanParams(),this._params.returnIdsOnly=!0,this._request(function(b,c){a.call(this,b,c&&c.objectIds,c)},b),this},bounds:function(a,b){return this._cleanParams(),this._params.returnExtentOnly=!0,this._request(function(c,d){a.call(b,c,d&&d.extent&&L.esri.Util.extentToBounds(d.extent),d)},b),this},pixelSize:function(a){return a=L.point(a),this._params.pixelSize=[a.x,a.y].join(","),this},layer:function(a){return this._urlPrefix=a+"/",this},_cleanParams:function(){delete this._params.returnIdsOnly,delete this._params.returnExtentOnly,delete this._params.returnCountOnly},_request:function(a,b){this._service?this._service.get(this._urlPrefix+"query",this._params,a,b):L.esri.get(this.url+this._urlPrefix+"query",this._params,a,b)}}),L.esri.Tasks.query=function(a,b){return new L.esri.Tasks.Query(a,b)},L.esri.Tasks.Find=L.Class.extend({initialize:function(a){a.url&&a.get?(this._service=a,this.url=a.url):this.url=L.esri.Util.cleanUrl(a),this._params={sr:4326,contains:!0,returnGeometry:!0,returnZ:!0,returnM:!1}},text:function(a){return this._params.searchText=a,this},contains:function(a){return this._params.contains=a,this},fields:function(a){return this._params.searchFields=this._params.searchFields?this._params.searchFields+",":"",this._params.searchFields+=L.Util.isArray(a)?a.join(","):a,this},spatialReference:function(a){return this._params.sr=a,this},layerDefs:function(a,b){return this._params.layerDefs=this._params.layerDefs?this._params.layerDefs+";":"",this._params.layerDefs+=[a,b].join(":"),this},layers:function(a){return this._params.layers=L.Util.isArray(a)?a.join(","):a,this},returnGeometry:function(a){return this._params.returnGeometry=a,this},maxAllowableOffset:function(a){return this._params.maxAllowableOffset=a,this},precision:function(a){return this._params.geometryPrecision=a,this},dynamicLayers:function(a){return this._params.dynamicLayers=a,this},returnZ:function(a){return this._params.returnZ=a,this},returnM:function(a){return this._params.returnM=a,this},gdbVersion:function(a){return this._params.gdbVersion=a,this},simplify:function(a,b){var c=Math.abs(a.getBounds().getWest()-a.getBounds().getEast());return this._params.maxAllowableOffset=c/a.getSize().y*b,this},token:function(a){return this._params.token=a,this},run:function(a,b){this._request(function(c,d){a.call(b,c,d&&L.esri.Util.responseToFeatureCollection(d),d)},b)},_request:function(a,b){this._service?this._service.get("find",this._params,a,b):L.esri.get(this.url+"find",this._params,a,b)}}),L.esri.Tasks.find=function(a,b){return new L.esri.Tasks.Find(a,b)},L.esri.Layers.RasterLayer=L.Class.extend({includes:L.Mixin.Events,options:{opacity:1,position:"front",f:"image"},onAdd:function(a){if(this._map=a,this._update=L.Util.limitExecByInterval(this._update,this.options.updateInterval,this),a.options.crs&&a.options.crs.code){var b=a.options.crs.code.split(":")[1];this.options.bboxSR=b,this.options.imageSR=b}this._map.addEventListener(this.getEvents(),this),this._update()},onRemove:function(){this._currentImage&&this._map.removeLayer(this._currentImage),this._popup&&(this._map.off("click",this._getPopupData,this),this._map.off("dblclick",this._resetPopupState,this)),this._map.removeEventListener(this.getEvents(),this)},addTo:function(a){return a.addLayer(this),this},removeFrom:function(a){return a.removeLayer(this),this},getEvents:function(){return{moveend:this._update}},bringToFront:function(){return this.options.position="front",this._currentImage&&this._currentImage.bringToFront(),this},bringToBack:function(){return this.options.position="back",this._currentImage&&this._currentImage.bringToBack(),this},getOpacity:function(){return this.options.opacity},setOpacity:function(a){return this.options.opacity=a,this._currentImage.setOpacity(a),this},getTimeRange:function(){return[this.options.from,this.options.to]},setTimeRange:function(a,b){return this.options.from=a,this.options.to=b,this._update(),this},metadata:function(a,b){return this._service.metadata(a,b),this},authenticate:function(a){return this._service.authenticate(a),this},_renderImage:function(a,b){var c=new L.ImageOverlay(a,b,{opacity:0}).addTo(this._map);c.once("load",function(a){var c=a.target,d=this._currentImage;c._bounds.equals(b)?(this._currentImage=c,"front"===this.options.position?this.bringToFront():this.bringToBack(),this._currentImage.setOpacity(this.options.opacity),d&&this._map.removeLayer(d)):this._map.removeLayer(c),this.fire("load",{bounds:b})},this),this.fire("loading",{bounds:b})},_update:function(){if(this._map){var a=this._map.getZoom(),b=this._map.getBounds();if(!this._animatingZoom&&!(this._map._panTransition&&this._map._panTransition._inProgress||a>this.options.maxZoom||a<this.options.minZoom)){var c=this._buildExportParams();this._requestExport(c,b)}}},_propagateEvent:function(a){a=L.extend({layer:a.target,target:this},a),this.fire(a.type,a)}}),L.esri.Layers.DynamicMapLayer=L.esri.Layers.RasterLayer.extend({options:{updateInterval:150,layers:!1,layerDefs:!1,timeOptions:!1,format:"png24",transparent:!0},initialize:function(a,b){this.url=L.esri.Util.cleanUrl(a),this._service=new L.esri.Services.MapService(this.url,b),this._service.on("authenticationrequired requeststart requestend requesterror requestsuccess",this._propagateEvent,this),L.Util.setOptions(this,b)},onAdd:function(a){L.esri.Layers.RasterLayer.prototype.onAdd.call(this,a),this._popup&&(this._map.on("click",this._getPopupData,this),this._map.on("dblclick",this._resetPopupState,this))},bindPopup:function(a,b){return this._shouldRenderPopup=!1,this._lastClick=!1,this._popup=L.popup(b),this._popupFunction=a,this._map&&(this._map.on("click",this._getPopupData,this),this._map.on("dblclick",this._resetPopupState,this)),this},unbindPopup:function(){return this._map&&(this._map.closePopup(this._popup),this._map.off("click",this._getPopupData,this),this._map.off("dblclick",this._resetPopupState,this)),this._popup=!1,this},getLayers:function(){return this.options.layers},setLayers:function(a){return this.options.layers=a,this._update(),this},getLayerDefs:function(){return this.options.layerDefs},setLayerDefs:function(a){return this.options.layerDefs=a,this._update(),this},getTimeOptions:function(){return this.options.timeOptions},setTimeOptions:function(a){return this.options.timeOptions=a,this._update(),this},query:function(){return this._service.query()},identify:function(){return this._service.identify()},find:function(){return this._service.find()},_getPopupData:function(a){var b=L.Util.bind(function(b,c,d){setTimeout(L.Util.bind(function(){this._renderPopup(a.latlng,b,c,d)},this),300)},this),c=this.identify().on(this._map).at(a.latlng);this.options.layers&&c.layers("visible:"+this.options.layers.join(",")),c.run(b),this._shouldRenderPopup=!0,this._lastClick=a.latlng},_renderPopup:function(a,b,c,d){if(this._shouldRenderPopup&&this._lastClick.equals(a)){var e=this._popupFunction(b,c,d);e&&this._popup.setLatLng(a).setContent(e).openOn(this._map)}},_resetPopupState:function(a){this._shouldRenderPopup=!1,this._lastClick=a.latlng},_buildExportParams:function(){var a=this._map.getBounds(),b=this._map.getSize(),c=this._map.options.crs.project(a._northEast),d=this._map.options.crs.project(a._southWest),e={bbox:[d.x,d.y,c.x,c.y].join(","),size:b.x+","+b.y,dpi:96,format:this.options.format,transparent:this.options.transparent,bboxSR:this.options.bboxSR,imageSR:this.options.imageSR};return this.options.layers&&(e.layers="show:"+this.options.layers.join(",")),this.options.layerDefs&&(e.layerDefs=JSON.stringify(this.options.layerDefs)),this.options.timeOptions&&(e.timeOptions=JSON.stringify(this.options.timeOptions)),this.options.from&&this.options.to&&(e.time=this.options.from.valueOf()+","+this.options.to.valueOf()),this._service.options.token&&(e.token=this._service.options.token),e},_requestExport:function(a,b){"json"===this.options.f?this._service.get("export",a,function(a,c){this._renderImage(c.href,b)},this):(a.f="image",this._renderImage(this.url+"export"+L.Util.getParamString(a),b))}}),L.esri.DynamicMapLayer=L.esri.Layers.DynamicMapLayer,L.esri.Layers.dynamicMapLayer=function(a,b){return new L.esri.Layers.DynamicMapLayer(a,b)},L.esri.dynamicMapLayer=function(a,b){return new L.esri.Layers.DynamicMapLayer(a,b)},L.esri.Layers.ImageMapLayer=L.esri.Layers.RasterLayer.extend({options:{updateInterval:150,format:"jpgpng"},query:function(){return this._service.query()},initialize:function(a,b){this.url=L.esri.Util.cleanUrl(a),this._service=new L.esri.Services.ImageService(this.url,b),this._service.on("authenticationrequired requeststart requestend requesterror requestsuccess",this._propagateEvent,this),L.Util.setOptions(this,b)},_buildExportParams:function(){var a=this._map.getBounds(),b=this._map.getSize(),c=this._map.options.crs.project(a._northEast),d=this._map.options.crs.project(a._southWest),e={bbox:[d.x,d.y,c.x,c.y].join(","),size:b.x+","+b.y,format:this.options.format,bboxSR:this.options.bboxSR,imageSR:this.options.imageSR};return this.options.from&&this.options.to&&(e.time=this.options.from.valueOf()+","+this.options.to.valueOf()),this.options.pixelType&&(e.pixelType=this.options.pixelType),this.options.noDataInterpretation&&(e.noDataInterpretation=this.options.noDataInterpretation),this.options.interpolation&&(e.interpolation=this.options.interpolation),this.options.compressionQuality&&(e.compressionQuality=this.options.compressionQuality),this.options.bandIds&&(e.bandIds=this.options.bandIds),this._service.options.token&&(e.token=this._service.options.token),e},_requestExport:function(a,b){"json"===this.options.f?this._service.get("exportImage",a,function(a,c){this._renderImage(c.href,b)},this):(a.f="image",this._renderImage(this.url+"exportImage"+L.Util.getParamString(a),b))}}),L.esri.ImageMapLayer=L.esri.Layers.ImageMapLayer,L.esri.Layers.imageMapLayer=function(a,b){return new L.esri.Layers.ImageMapLayer(a,b)},L.esri.imageMapLayer=function(a,b){return new L.esri.Layers.ImageMapLayer(a,b)},L.esri.Layers.TiledMapLayer=L.TileLayer.extend({initialize:function(a,b){b=L.Util.setOptions(this,b),this.url=L.esri.Util.cleanUrl(a),this.tileUrl=L.esri.Util.cleanUrl(a)+"tile/{z}/{y}/{x}",this._service=new L.esri.Services.MapService(this.url,b),this._service.on("authenticationrequired requeststart requestend requesterror requestsuccess",this._propagateEvent,this),this.tileUrl.match("://tiles.arcgisonline.com")&&(this.tileUrl=this.tileUrl.replace("://tiles.arcgisonline.com","://tiles{s}.arcgisonline.com"),b.subdomains=["1","2","3","4"]),L.TileLayer.prototype.initialize.call(this,this.tileUrl,b)},metadata:function(a,b){return this._service.metadata(a,b),this},identify:function(){return this._service.identify()},authenticate:function(a){return this._service.authenticate(a),this},_propagateEvent:function(a){a=L.extend({layer:a.target,target:this},a),this.fire(a.type,a)}}),L.esri.TiledMapLayer=L.esri.Layers.tiledMapLayer,L.esri.Layers.tiledMapLayer=function(a,b){return new L.esri.Layers.TiledMapLayer(a,b)},L.esri.tiledMapLayer=function(a,b){return new L.esri.Layers.TiledMapLayer(a,b)};